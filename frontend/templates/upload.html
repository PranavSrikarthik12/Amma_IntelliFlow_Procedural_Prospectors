<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amma ¬∑ Upload Report</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --c-bg: #03050a;
      --c-glow: #00f5d4;
      --c-purple: #7c3aed;
      --c-blue: #0ea5e9;
      --c-white: #f0f4ff;
      --c-muted: #475569;
      --c-surface: rgba(255,255,255,0.03);
      --c-border: rgba(0,245,212,0.1);
      --c-border-bright: rgba(0,245,212,0.25);
      --c-emerald: #10b981;
      --c-ruby: #f43f5e;
      --c-amber: #f59e0b;
      --c-accent: #ff6b35;
      --sidebar-w: 260px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--c-bg);
      color: var(--c-white);
      font-family: 'DM Sans', sans-serif;
      display: flex;
      min-height: 100vh;
      cursor: none;
    }

    /* ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ */
    .cursor { position: fixed; width: 12px; height: 12px; background: var(--c-glow); border-radius: 50%; pointer-events: none; z-index: 9999; mix-blend-mode: screen; top: 0; left: 0; transition: transform .1s; }
    .cursor-ring { position: fixed; width: 38px; height: 38px; border: 1px solid rgba(0,245,212,.35); border-radius: 50%; pointer-events: none; z-index: 9998; top: 0; left: 0; }

    /* ‚îÄ‚îÄ NOISE + SCANLINE ‚îÄ‚îÄ */
    body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.035'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9000; }
    .scan-line { position: fixed; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--c-glow), transparent); opacity: .08; animation: scanDown 8s linear infinite; pointer-events: none; z-index: 9001; }
    @keyframes scanDown { from { top: -2px; } to { top: 100%; } }

    #bg-canvas { position: fixed; inset: 0; z-index: 0; }

    /* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
    #loader { position: fixed; inset: 0; background: var(--c-bg); z-index: 8000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 18px; transition: opacity .7s, visibility .7s; }
    #loader.hide { opacity: 0; visibility: hidden; pointer-events: none; }
    .loader-title { font-family: 'Bebas Neue', sans-serif; font-size: clamp(2.2rem, 6vw, 4.5rem); letter-spacing: .3em; background: linear-gradient(90deg, var(--c-glow), var(--c-blue), var(--c-purple), var(--c-glow)); background-size: 300%; -webkit-background-clip: text; color: transparent; animation: shimmer 1.6s linear infinite; }
    .loader-sub { font-family: 'Space Mono', monospace; font-size: .6rem; letter-spacing: .3em; color: #1e293b; }
    .loader-bar { width: 220px; height: 2px; background: rgba(255,255,255,.06); border-radius: 2px; overflow: hidden; }
    .loader-fill { height: 100%; background: linear-gradient(90deg, var(--c-glow), var(--c-blue)); width: 0%; animation: loadFill 1.8s ease forwards; border-radius: 2px; }
    @keyframes loadFill { to { width: 100%; } }
    @keyframes shimmer { 0% { background-position: 0%; } 100% { background-position: 200%; } }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100vh;
      background: rgba(3,5,10,.96);
      border-right: 1px solid var(--c-border);
      position: fixed; top: 0; left: 0;
      display: flex; flex-direction: column;
      z-index: 200;
    }
    .sidebar::after { content: ''; position: absolute; top: 0; right: 0; width: 1px; height: 100%; background: linear-gradient(180deg, transparent, var(--c-glow) 40%, var(--c-purple) 70%, transparent); opacity: .18; }

    .sidebar-logo { padding: 24px 20px 18px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--c-border); }
    .logo-ring { animation: logoSpin 8s linear infinite; transform-origin: center; }
    @keyframes logoSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .logo-name { font-family: 'Bebas Neue', sans-serif; font-size: 19px; letter-spacing: .15em; background: linear-gradient(135deg, var(--c-glow), var(--c-blue)); -webkit-background-clip: text; color: transparent; }
    .logo-tagline { font-family: 'Space Mono', monospace; font-size: .52rem; letter-spacing: .16em; color: var(--c-muted); text-transform: uppercase; margin-top: 2px; }

    .nav-section-label { padding: 14px 20px 5px; font-family: 'Space Mono', monospace; font-size: .58rem; font-weight: 700; letter-spacing: .2em; text-transform: uppercase; color: var(--c-muted); display: flex; align-items: center; gap: 8px; }
    .nav-section-label::after { content: ''; flex: 1; height: 1px; background: var(--c-border); }

    .nav-link-item { display: flex; align-items: center; gap: 11px; padding: 10px 20px; color: var(--c-muted); font-size: .84rem; font-weight: 500; text-decoration: none; border-left: 2px solid transparent; transition: all .22s; margin: 1px 0; }
    .nav-link-item .nav-ic { width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; background: transparent; transition: all .22s; flex-shrink: 0; }
    .nav-link-item:hover { color: var(--c-white); background: linear-gradient(90deg, rgba(0,245,212,.04), transparent); border-left-color: var(--c-glow); }
    .nav-link-item:hover .nav-ic { background: rgba(0,245,212,.07); }
    .nav-link-item.active { color: var(--c-white); background: linear-gradient(90deg, rgba(0,245,212,.07), transparent); border-left-color: var(--c-glow); }
    .nav-link-item.active .nav-label-text { color: var(--c-glow); }
    .nav-link-item.active .nav-ic { background: rgba(0,245,212,.1); }
    .nav-badge-pill { margin-left: auto; font-family: 'Space Mono', monospace; font-size: .58rem; font-weight: 700; padding: 2px 7px; border-radius: 20px; background: rgba(124,58,237,.15); border: 1px solid rgba(124,58,237,.3); color: #a78bfa; }

    .sidebar-footer { padding: 14px 20px; border-top: 1px solid var(--c-border); margin-top: auto; }
    .user-pill { display: flex; align-items: center; gap: 10px; padding: 9px 11px; border-radius: 10px; background: var(--c-surface); border: 1px solid var(--c-border); cursor: pointer; transition: all .22s; }
    .user-pill:hover { border-color: var(--c-border-bright); background: rgba(0,245,212,.04); }
    .user-avatar { width: 34px; height: 34px; border-radius: 9px; background: linear-gradient(135deg, var(--c-purple), #1c1535); display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 14px; color: var(--c-glow); border: 1px solid rgba(0,245,212,.18); flex-shrink: 0; }
    .user-name-text { font-size: .78rem; font-weight: 600; color: var(--c-white); }
    .user-role-text { font-family: 'Space Mono', monospace; font-size: .58rem; color: var(--c-muted); }
    .online-dot { width: 7px; height: 7px; background: var(--c-emerald); border-radius: 50%; margin-left: auto; animation: blink 2s infinite; }
    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: .35; } }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main-wrap { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; min-height: 100vh; position: relative; z-index: 1; }

    /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
    .topbar { height: 66px; background: rgba(3,5,10,.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--c-border); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; padding: 0 28px; gap: 16px; }
    .topbar-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.25rem; letter-spacing: .15em; color: var(--c-white); }
    .topbar-sub { font-family: 'Space Mono', monospace; font-size: .58rem; letter-spacing: .1em; color: var(--c-muted); }
    .clock-pill { font-family: 'Space Mono', monospace; font-size: .68rem; color: var(--c-glow); background: rgba(0,245,212,.07); border: 1px solid rgba(0,245,212,.18); padding: 6px 13px; border-radius: 20px; }
    .secure-pill { display: flex; align-items: center; gap: 5px; font-family: 'Space Mono', monospace; font-size: .62rem; font-weight: 700; color: var(--c-emerald); background: rgba(16,185,129,.07); border: 1px solid rgba(16,185,129,.18); padding: 5px 11px; border-radius: 20px; }
    .secure-dot { width: 5px; height: 5px; background: var(--c-emerald); border-radius: 50%; animation: blink 2s infinite; }
    .btn-dash { display: flex; align-items: center; gap: 7px; padding: 7px 17px; background: var(--c-surface); color: var(--c-muted); border: 1px solid var(--c-border); border-radius: 30px; font-family: 'Space Mono', monospace; font-size: .66rem; font-weight: 700; text-decoration: none; letter-spacing: .06em; text-transform: uppercase; transition: all .22s; }
    .btn-dash:hover { border-color: var(--c-glow); color: var(--c-glow); background: rgba(0,245,212,.06); }

    /* ‚îÄ‚îÄ PAGE BODY ‚îÄ‚îÄ */
    .page-body { padding: 28px 28px; flex: 1; }

    /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
    .hero-title { font-family: 'Bebas Neue', sans-serif; font-size: clamp(1.9rem, 3vw, 2.6rem); letter-spacing: .08em; line-height: 1.1; }
    .hero-title span { background: linear-gradient(135deg, var(--c-glow), var(--c-blue)); -webkit-background-clip: text; color: transparent; }
    .hero-sub { font-size: .82rem; color: var(--c-muted); margin-top: 5px; }
    .section-divider { display: flex; align-items: center; gap: 10px; font-family: 'Space Mono', monospace; font-size: .58rem; font-weight: 700; letter-spacing: .2em; text-transform: uppercase; color: var(--c-accent); margin: 22px 0 16px; }
    .section-divider::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, var(--c-accent), transparent); }

    /* ‚îÄ‚îÄ GLASS CARD ‚îÄ‚îÄ */
    .glass-card { background: var(--c-surface); border: 1px solid var(--c-border); border-radius: 14px; overflow: hidden; position: relative; transition: border-color .25s; }
    .glass-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--c-glow), var(--c-purple), transparent); opacity: .18; z-index: 1; }
    .glass-card:hover { border-color: var(--c-border-bright); }
    .gc-header { padding: 16px 22px 13px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--c-border); }
    .gc-title { display: flex; align-items: center; gap: 9px; font-family: 'Space Mono', monospace; font-size: .72rem; font-weight: 700; letter-spacing: .1em; color: var(--c-white); text-transform: uppercase; }
    .gc-icon { width: 28px; height: 28px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 13px; }
    .gci-glow { background: rgba(0,245,212,.1); border: 1px solid var(--c-border-bright); }
    .gci-blue { background: rgba(14,165,233,.1); border: 1px solid rgba(14,165,233,.2); }
    .gci-emerald { background: rgba(16,185,129,.1); border: 1px solid rgba(16,185,129,.15); }
    .gc-body { padding: 20px 22px; }

    /* ‚îÄ‚îÄ FIELD LABEL ‚îÄ‚îÄ */
    .field-lbl { display: block; font-family: 'Space Mono', monospace; font-size: .58rem; font-weight: 700; letter-spacing: .14em; text-transform: uppercase; color: var(--c-muted); margin-bottom: 8px; }

    /* ‚îÄ‚îÄ TYPE CARDS ‚îÄ‚îÄ */
    .type-card { padding: 13px 15px; border-radius: 10px; border: 1px solid var(--c-border); background: rgba(0,0,0,.2); cursor: pointer; transition: all .22s; display: flex; align-items: center; gap: 11px; position: relative; }
    .type-card:hover { border-color: var(--c-border-bright); background: rgba(0,245,212,.03); }
    .type-card.selected { border-color: var(--c-glow) !important; background: rgba(0,245,212,.06) !important; }
    .type-card.selected .type-card-name { color: var(--c-glow); }
    .type-card-ico { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 15px; background: rgba(255,255,255,.04); flex-shrink: 0; }
    .type-card.selected .type-card-ico { background: rgba(0,245,212,.1); }
    .type-card-name { font-size: .81rem; font-weight: 600; color: var(--c-white); transition: color .22s; }
    .type-card-desc { font-family: 'Space Mono', monospace; font-size: .58rem; color: var(--c-muted); margin-top: 2px; }
    .type-radio { position: absolute; top: 9px; right: 9px; width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid var(--c-border); transition: all .22s; }
    .type-card.selected .type-radio { background: var(--c-glow); border-color: var(--c-glow); box-shadow: 0 0 0 3px rgba(0,245,212,.15); }

    /* ‚îÄ‚îÄ DROPZONE ‚îÄ‚îÄ */
    .dropzone { border: 1.5px dashed rgba(0,245,212,.18); border-radius: 12px; padding: 36px 22px; text-align: center; cursor: pointer; transition: all .28s; background: rgba(0,0,0,.2); position: relative; overflow: hidden; }
    .dropzone::before { content: ''; position: absolute; inset: 0; background-image: linear-gradient(rgba(0,245,212,.025) 1px, transparent 1px), linear-gradient(90deg, rgba(0,245,212,.025) 1px, transparent 1px); background-size: 26px 26px; }
    .dropzone:hover, .dropzone.dragover { border-color: var(--c-glow); background: rgba(0,245,212,.04); }
    .file-input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 2; }
    .dz-icon { width: 54px; height: 54px; background: rgba(255,255,255,.04); border: 1px solid var(--c-border-bright); border-radius: 13px; display: flex; align-items: center; justify-content: center; margin: 0 auto 13px; position: relative; z-index: 1; animation: floatIcon 3s ease-in-out infinite; }
    @keyframes floatIcon { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    .dropzone:hover .dz-icon { background: rgba(0,245,212,.1); border-color: var(--c-glow); }
    .dz-title { font-family: 'Space Mono', monospace; font-size: .78rem; font-weight: 700; color: var(--c-white); margin-bottom: 4px; position: relative; z-index: 1; }
    .dz-sub { font-size: .76rem; color: var(--c-muted); position: relative; z-index: 1; }
    .format-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 11px; background: rgba(255,255,255,.04); border: 1px solid var(--c-border); border-radius: 20px; font-family: 'Space Mono', monospace; font-size: .6rem; color: var(--c-muted); margin-top: 11px; position: relative; z-index: 1; }

    /* ‚îÄ‚îÄ FILE SELECTED ‚îÄ‚îÄ */
    .file-selected { display: none; align-items: center; gap: 11px; padding: 11px 15px; margin-top: 11px; background: rgba(0,245,212,.05); border: 1px solid var(--c-border-bright); border-radius: 10px; }
    .file-ico { width: 34px; height: 34px; border-radius: 8px; background: var(--c-surface); border: 1px solid var(--c-border); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .file-name { font-size: .8rem; font-weight: 600; color: var(--c-white); }
    .file-size { font-family: 'Space Mono', monospace; font-size: .62rem; color: var(--c-muted); margin-top: 1px; }
    .file-remove { margin-left: auto; cursor: pointer; color: var(--c-muted); width: 26px; height: 26px; border-radius: 7px; display: flex; align-items: center; justify-content: center; transition: all .2s; border: none; background: transparent; }
    .file-remove:hover { background: rgba(244,63,94,.15); color: var(--c-ruby); }

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .progress-wrap { display: none; margin-top: 14px; padding: 14px 16px; background: rgba(0,0,0,.25); border: 1px solid var(--c-border); border-radius: 10px; }
    .progress-label { display: flex; justify-content: space-between; font-family: 'Space Mono', monospace; font-size: .62rem; color: var(--c-muted); margin-bottom: 9px; }
    .progress-pct { color: var(--c-glow); }
    .progress-track { height: 4px; background: rgba(255,255,255,.06); border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--c-glow), var(--c-blue)); transition: width .3s ease; width: 0%; }
    .progress-dots { display: flex; gap: 5px; margin-top: 9px; }
    .p-dot { flex: 1; height: 3px; border-radius: 3px; background: rgba(255,255,255,.06); transition: background .5s; }
    .p-dot.done { background: var(--c-glow); }
    .p-dot.active { background: linear-gradient(90deg, var(--c-glow), var(--c-blue)); animation: dotPulse 1s ease-in-out infinite; }
    @keyframes dotPulse { 0%,100% { opacity: 1; } 50% { opacity: .45; } }
    .progress-stage { font-family: 'Space Mono', monospace; font-size: .62rem; color: var(--c-muted); margin-top: 8px; }

    /* ‚îÄ‚îÄ SUCCESS BANNER ‚îÄ‚îÄ */
    .success-banner { display: none; align-items: center; gap: 13px; padding: 13px 16px; margin-top: 13px; background: rgba(16,185,129,.06); border: 1px solid rgba(16,185,129,.2); border-left: 3px solid var(--c-emerald); border-radius: 10px; }
    .success-ico { width: 34px; height: 34px; border-radius: 8px; background: rgba(16,185,129,.12); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .success-title { font-family: 'Space Mono', monospace; font-size: .76rem; font-weight: 700; color: var(--c-emerald); }
    .success-msg { font-size: .7rem; color: rgba(16,185,129,.65); margin-top: 2px; }

    /* ‚îÄ‚îÄ ANOMALY ‚îÄ‚îÄ */
    .anomaly-wrap { display: none; margin-top: 13px; padding: 13px 16px; background: rgba(245,158,11,.05); border: 1px solid rgba(245,158,11,.15); border-left: 3px solid var(--c-amber); border-radius: 10px; }
    .anomaly-hdr { display: flex; align-items: center; gap: 7px; font-family: 'Space Mono', monospace; font-size: .62rem; font-weight: 700; color: var(--c-amber); margin-bottom: 9px; letter-spacing: .1em; text-transform: uppercase; }
    .anomaly-item { display: flex; align-items: flex-start; gap: 9px; padding: 8px 11px; margin-bottom: 6px; background: rgba(0,0,0,.2); border: 1px solid rgba(245,158,11,.08); border-radius: 8px; font-size: .78rem; color: var(--c-muted); line-height: 1.5; }
    .anomaly-item:last-child { margin-bottom: 0; }
    .badge-sev { flex-shrink: 0; padding: 2px 8px; border-radius: 20px; font-family: 'Space Mono', monospace; font-size: .56rem; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; }
    .badge-high { background: rgba(244,63,94,.1); color: var(--c-ruby); border: 1px solid rgba(244,63,94,.2); }
    .badge-medium { background: rgba(245,158,11,.1); color: var(--c-amber); border: 1px solid rgba(245,158,11,.2); }
    .badge-low { background: rgba(16,185,129,.1); color: var(--c-emerald); border: 1px solid rgba(16,185,129,.2); }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-clear-form { padding: 10px 20px; background: transparent; color: var(--c-muted); border: 1px solid var(--c-border); border-radius: 30px; font-family: 'Space Mono', monospace; font-size: .68rem; font-weight: 700; cursor: pointer; transition: all .22s; letter-spacing: .06em; text-transform: uppercase; width: 100%; }
    .btn-clear-form:hover { border-color: var(--c-ruby); color: var(--c-ruby); background: rgba(244,63,94,.07); }

    .btn-upload-main { padding: 11px 22px; background: linear-gradient(135deg, var(--c-glow), var(--c-blue)); color: #03050a; border: none; border-radius: 30px; font-family: 'Space Mono', monospace; font-size: .72rem; font-weight: 700; cursor: pointer; transition: all .28s cubic-bezier(.4,0,.2,1); letter-spacing: .08em; text-transform: uppercase; box-shadow: 0 4px 18px rgba(0,245,212,.2); display: flex; align-items: center; justify-content: center; gap: 7px; width: 100%; }
    .btn-upload-main:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,245,212,.35); }
    .btn-upload-main:disabled { opacity: .28; cursor: not-allowed; transform: none; box-shadow: none; }

    /* ‚îÄ‚îÄ STEP ROWS ‚îÄ‚îÄ */
    .step-row { display: flex; align-items: flex-start; gap: 13px; padding: 10px 0; border-bottom: 1px solid var(--c-border); transition: padding .2s; }
    .step-row:last-child { border-bottom: none; padding-bottom: 0; }
    .step-row:hover { padding-left: 4px; }
    .step-num { width: 26px; height: 26px; border-radius: 7px; background: rgba(0,245,212,.1); border: 1px solid var(--c-border-bright); color: var(--c-glow); font-family: 'Space Mono', monospace; font-size: .62rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .step-title { font-size: .8rem; font-weight: 600; color: var(--c-white); }
    .step-desc { font-family: 'Space Mono', monospace; font-size: .6rem; color: var(--c-muted); margin-top: 2px; line-height: 1.5; }

    /* ‚îÄ‚îÄ TIP ROWS ‚îÄ‚îÄ */
    .tip-row { display: flex; align-items: flex-start; gap: 9px; padding: 8px 0; border-bottom: 1px solid var(--c-border); font-size: .78rem; color: var(--c-muted); line-height: 1.55; }
    .tip-row:last-child { border-bottom: none; padding-bottom: 0; }
    .tip-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--c-glow); flex-shrink: 0; margin-top: 6px; }

    /* ‚îÄ‚îÄ RECENT ‚îÄ‚îÄ */
    .recent-item { display: flex; align-items: center; gap: 11px; padding: 9px 0; border-bottom: 1px solid var(--c-border); transition: padding .2s; }
    .recent-item:last-child { border-bottom: none; }
    .recent-item:hover { padding-left: 4px; }
    .recent-ico { width: 30px; height: 30px; border-radius: 7px; background: var(--c-surface); border: 1px solid var(--c-border); display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
    .recent-name { font-size: .76rem; font-weight: 600; color: var(--c-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recent-time { font-family: 'Space Mono', monospace; font-size: .58rem; color: var(--c-muted); margin-top: 1px; }
    .done-badge { margin-left: auto; padding: 2px 8px; background: rgba(16,185,129,.1); color: var(--c-emerald); border: 1px solid rgba(16,185,129,.2); border-radius: 20px; font-family: 'Space Mono', monospace; font-size: .56rem; font-weight: 700; flex-shrink: 0; }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer { padding: 18px 28px; border-top: 1px solid var(--c-border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; position: relative; z-index: 10; }
    .footer-brand { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; background: linear-gradient(90deg, var(--c-glow), var(--c-blue)); -webkit-background-clip: text; color: transparent; letter-spacing: .15em; }
    .footer-copy { font-family: 'Space Mono', monospace; font-size: .58rem; color: var(--c-muted); }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes riseUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
    .anim-rise { animation: riseUp .65s ease forwards; opacity: 0; }
    .anim-rise-1 { animation-delay: .1s; }
    .anim-rise-2 { animation-delay: .2s; }
    .anim-rise-3 { animation-delay: .3s; }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 1100px) {
      :root { --sidebar-w: 66px; }
      .logo-text-wrap, .nav-badge-pill, .nav-section-label, .user-name-text, .user-role-text { display: none; }
      .nav-link-item { justify-content: center; padding: 11px; }
      .sidebar-footer { padding: 8px; }
      .user-pill { justify-content: center; }
    }
    @media (max-width: 768px) {
      :root { --sidebar-w: 0px; }
      .sidebar { transform: translateX(-260px); }
      .page-body { padding: 16px; }
    }
  </style>
</head>
<body>

  <!-- CURSOR -->
  <div class="cursor" id="cursor"></div>
  <div class="cursor-ring" id="cursor-ring"></div>
  <div class="scan-line"></div>

  <!-- LOADER -->
  <div id="loader">
    <div class="loader-title">UPLOAD DATA</div>
    <div class="loader-sub">AMMA ¬∑ AI PIPELINE</div>
    <div class="loader-bar"><div class="loader-fill"></div></div>
  </div>

  <canvas id="bg-canvas"></canvas>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div style="width:40px;height:40px;flex-shrink:0;">
        <svg viewBox="0 0 44 44" fill="none" width="40" height="40">
          <circle cx="22" cy="22" r="20" stroke="rgba(0,245,212,0.12)" stroke-width="1.5"/>
          <g class="logo-ring">
            <circle cx="22" cy="22" r="18" stroke="url(#sg)" stroke-width="1" stroke-dasharray="6 4" stroke-linecap="round"/>
          </g>
          <circle cx="22" cy="22" r="12" fill="rgba(0,245,212,0.05)" stroke="rgba(0,245,212,0.2)" stroke-width="1"/>
          <text x="22" y="27" text-anchor="middle" font-family="'Bebas Neue'" font-size="13" fill="url(#tg)">A</text>
          <defs>
            <linearGradient id="sg" x1="4" y1="4" x2="40" y2="40"><stop offset="0%" stop-color="#00f5d4"/><stop offset="100%" stop-color="#7c3aed"/></linearGradient>
            <linearGradient id="tg" x1="0" y1="0" x2="44" y2="44"><stop offset="0%" stop-color="#00f5d4"/><stop offset="100%" stop-color="#0ea5e9"/></linearGradient>
          </defs>
        </svg>
      </div>
      <div class="logo-text-wrap">
        <div class="logo-name">AMMA</div>
        <div class="logo-tagline">Supply Chain Intelligence</div>
      </div>
    </div>

    <nav style="flex:1;padding:14px 0;overflow-y:auto;">
      <div class="nav-section-label">Core</div>
      <a class="nav-link-item" href="/dashboard">
        <div class="nav-ic"><i class="bi bi-grid-fill"></i></div>
        <span class="nav-label-text">Dashboard</span>
      </a>
      <a class="nav-link-item active" href="/upload">
        <div class="nav-ic"><i class="bi bi-upload"></i></div>
        <span class="nav-label-text">Upload Reports</span>
      </a>
      <a class="nav-link-item" href="/agents">
        <div class="nav-ic"><i class="bi bi-cpu"></i></div>
        <span class="nav-label-text">Agent Workflow</span>
        <span class="nav-badge-pill">Live</span>
      </a>

      <div class="nav-section-label">Analytics</div>
      <a class="nav-link-item" href="/dashboard#analytics">
        <div class="nav-ic"><i class="bi bi-activity"></i></div>
        <span class="nav-label-text">Analytics</span>
      </a>
      <a class="nav-link-item" href="/dashboard#insights">
        <div class="nav-ic"><i class="bi bi-lightbulb"></i></div>
        <span class="nav-label-text">AI Insights</span>
      </a>

      <div class="nav-section-label">System</div>
      <a class="nav-link-item" href="/alerts">
        <div class="nav-ic"><i class="bi bi-bell"></i></div>
        <span class="nav-label-text">Alerts</span>
      </a>
      <a class="nav-link-item" href="/settings">
        <div class="nav-ic"><i class="bi bi-gear"></i></div>
        <span class="nav-label-text">Settings</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-pill">
        <div class="user-avatar">AM</div>
        <div>
          <div class="user-name-text">Admin</div>
          <div class="user-role-text">Senior Analyst</div>
        </div>
        <div class="online-dot"></div>
      </div>
    </div>
  </aside>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="main-wrap">

    <!-- TOPBAR -->
    <header class="topbar">
      <div>
        <div class="topbar-title">UPLOAD REPORT</div>
        <div class="topbar-sub">INVOICE &amp; DISBURSEMENT INGESTION</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <div class="secure-pill"><span class="secure-dot"></span>SECURE</div>
        <div class="clock-pill" id="liveClock">‚Äî</div>
        <a class="btn-dash" href="/dashboard">
          <i class="bi bi-chevron-left"></i> DASHBOARD
        </a>
      </div>
    </header>

    <!-- PAGE BODY -->
    <div class="page-body">

      <!-- HERO -->
      <div class="d-flex align-items-start justify-content-between mb-3 anim-rise anim-rise-1">
        <div>
          <div class="hero-title">Ingest <span>Supply Chain Data</span> üì§</div>
          <div class="hero-sub">Upload your invoice or disbursement CSV to trigger the AI pipeline.</div>
        </div>
        <div class="d-flex flex-column align-items-end gap-2">
          <div style="font-family:'Space Mono',monospace;font-size:.68rem;color:var(--c-muted);background:var(--c-surface);border:1px solid var(--c-border);padding:6px 13px;border-radius:20px;" id="heroDate">‚Äî</div>
          <div class="secure-pill" style="font-size:.62rem;"><span class="secure-dot"></span>ENCRYPTED</div>
        </div>
      </div>

      <div class="section-divider anim-rise anim-rise-2">Report Configuration</div>

      <!-- GRID -->
      <div class="row g-3 anim-rise anim-rise-3">

        <!-- ‚îÄ‚îÄ LEFT FORM ‚îÄ‚îÄ -->
        <div class="col-lg-8">
          <div class="glass-card">
            <div class="gc-header">
              <div class="gc-title">
                <div class="gc-icon gci-glow"><i class="bi bi-upload" style="color:var(--c-glow);font-size:12px;"></i></div>
                Upload Report File
              </div>
              <span style="font-family:'Space Mono',monospace;font-size:.58rem;color:var(--c-muted);">CSV ONLY</span>
            </div>
            <div class="gc-body">
              <form id="uploadForm">

                <!-- ‚îÄ‚îÄ‚îÄ FIX 1: Hidden input for report type with default options ‚îÄ‚îÄ‚îÄ -->
                <input type="hidden" name="type" id="reportTypeInput" value="">

                <!-- Type Cards -->
                <div class="mb-3">
                  <label class="field-lbl">Select Report Type</label>
                  <div class="row g-2">
                    <div class="col-6">
                      <div class="type-card" id="card-invoice" onclick="selectType('invoice')">
                        <div class="type-card-ico">üßæ</div>
                        <div>
                          <div class="type-card-name">Invoice Report</div>
                          <div class="type-card-desc">Rejection rates &amp; approval flows</div>
                        </div>
                        <div class="type-radio"></div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="type-card" id="card-disbursement" onclick="selectType('disbursement')">
                        <div class="type-card-ico">üí∏</div>
                        <div>
                          <div class="type-card-name">Disbursement Report</div>
                          <div class="type-card-desc">Delay analysis &amp; cash flow</div>
                        </div>
                        <div class="type-radio"></div>
                      </div>
                    </div>
                  </div>
                  <!-- ‚îÄ‚îÄ‚îÄ FIX 2: Validation message for type ‚îÄ‚îÄ‚îÄ -->
                  <div id="typeError" style="display:none;font-family:'Space Mono',monospace;font-size:.62rem;color:var(--c-ruby);margin-top:6px;">‚ö† Please select a report type</div>
                </div>

                <!-- Dropzone -->
                <div class="mb-2">
                  <label class="field-lbl">Upload File</label>
                  <div class="dropzone" id="dropzone">
                    <!-- ‚îÄ‚îÄ‚îÄ FIX 3: Removed 'required' from file input to handle validation manually ‚îÄ‚îÄ‚îÄ -->
                    <input type="file" name="file" id="fileInput" class="file-input" accept=".csv">
                    <div class="dz-icon">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00f5d4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                      </svg>
                    </div>
                    <div class="dz-title">Drop your CSV file here</div>
                    <div class="dz-sub">or click to browse</div>
                    <div><span class="format-tag">üìÑ .CSV format only</span></div>
                  </div>
                  <div id="fileError" style="display:none;font-family:'Space Mono',monospace;font-size:.62rem;color:var(--c-ruby);margin-top:6px;">‚ö† Please select a CSV file</div>
                </div>

                <!-- File selected -->
                <div class="file-selected" id="fileSelected">
                  <div class="file-ico">üìé</div>
                  <div style="flex:1;min-width:0;">
                    <div class="file-name" id="fileNameText">‚Äî</div>
                    <div class="file-size" id="fileSizeText">‚Äî</div>
                  </div>
                  <button type="button" class="file-remove" onclick="removeFile()" title="Remove">
                    <i class="bi bi-x"></i>
                  </button>
                </div>

                <!-- Progress -->
                <div class="progress-wrap" id="progressWrap">
                  <div class="progress-label">
                    <span>Processing through AI pipeline‚Ä¶</span>
                    <span class="progress-pct" id="progressPct">0%</span>
                  </div>
                  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
                  <div class="progress-dots">
                    <div class="p-dot" id="pd1"></div><div class="p-dot" id="pd2"></div>
                    <div class="p-dot" id="pd3"></div><div class="p-dot" id="pd4"></div>
                    <div class="p-dot" id="pd5"></div><div class="p-dot" id="pd6"></div>
                  </div>
                  <div class="progress-stage" id="progressStage">Uploading file‚Ä¶</div>
                </div>

                <!-- Success -->
                <div class="success-banner" id="successBanner">
                  <div class="success-ico">‚úÖ</div>
                  <div>
                    <div class="success-title">Report processed successfully!</div>
                    <div class="success-msg" id="successMsg">Redirecting to dashboard‚Ä¶</div>
                  </div>
                </div>

                <!-- Anomalies -->
                <div class="anomaly-wrap" id="anomalyWrap">
                  <div class="anomaly-hdr">
                    <i class="bi bi-exclamation-triangle"></i> Detected Anomalies
                  </div>
                  <div id="anomalyList"></div>
                </div>

                <!-- Action Buttons -->
                <div class="row g-2 mt-3">
                  <div class="col-4">
                    <button type="button" class="btn-clear-form" onclick="resetForm()">
                      <i class="bi bi-arrow-counterclockwise me-1"></i>Clear
                    </button>
                  </div>
                  <div class="col-8">
                    <!-- ‚îÄ‚îÄ‚îÄ FIX 4: Button starts disabled, enabled after validation ‚îÄ‚îÄ‚îÄ -->
                    <button type="button" id="submitBtn" class="btn-upload-main" disabled onclick="handleUpload()">
                      <i class="bi bi-upload"></i> Upload Report
                    </button>
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ RIGHT SIDE ‚îÄ‚îÄ -->
        <div class="col-lg-4">

          <!-- How it works -->
          <div class="glass-card mb-3">
            <div class="gc-header">
              <div class="gc-title">
                <div class="gc-icon gci-blue"><i class="bi bi-info-circle" style="color:var(--c-blue);font-size:12px;"></i></div>
                How It Works
              </div>
            </div>
            <div class="gc-body" style="padding-top:13px;padding-bottom:15px;">
              <div class="step-row">
                <div class="step-num">01</div>
                <div><div class="step-title">Select Report Type</div><div class="step-desc">Choose Invoice or Disbursement</div></div>
              </div>
              <div class="step-row">
                <div class="step-num">02</div>
                <div><div class="step-title">Upload CSV File</div><div class="step-desc">Drag &amp; drop or click to browse</div></div>
              </div>
              <div class="step-row">
                <div class="step-num">03</div>
                <div><div class="step-title">AI Pipeline Runs</div><div class="step-desc">7 agents analyze, embed &amp; flag</div></div>
              </div>
              <div class="step-row">
                <div class="step-num">04</div>
                <div><div class="step-title">View Dashboard</div><div class="step-desc">Charts, findings &amp; action items</div></div>
              </div>
            </div>
          </div>

          <!-- Recent Uploads -->
          <div class="glass-card mb-3" id="recentSection" style="display:none;">
            <div class="gc-header">
              <div class="gc-title">
                <div class="gc-icon gci-emerald"><i class="bi bi-clock-history" style="color:var(--c-emerald);font-size:12px;"></i></div>
                Recent Uploads
              </div>
            </div>
            <div class="gc-body" style="padding-top:12px;padding-bottom:13px;">
              <div id="recentList"></div>
            </div>
          </div>

          <!-- Tips -->
          <div class="glass-card">
            <div class="gc-header">
              <div class="gc-title">
                <div class="gc-icon gci-glow"><i class="bi bi-lightbulb" style="color:var(--c-glow);font-size:12px;"></i></div>
                Tips &amp; Format
              </div>
            </div>
            <div class="gc-body" style="padding-top:13px;padding-bottom:15px;">
              <div class="tip-row"><div class="tip-dot"></div><span>Only <strong style="color:var(--c-white);">.CSV</strong> files are accepted</span></div>
              <div class="tip-row"><div class="tip-dot"></div><span>Ensure column headers match schema</span></div>
              <div class="tip-row"><div class="tip-dot"></div><span>Invoice &amp; Disbursement have different schemas</span></div>
              <div class="tip-row"><div class="tip-dot"></div><span>Large files (&gt;5MB) may take a few seconds</span></div>
            </div>
          </div>

        </div>
      </div><!-- /row -->
    </div><!-- /page-body -->

    <footer>
      <div class="footer-brand">TECHATHON 2.0</div>
      <div class="footer-copy">¬© 2025 Procedural Prospectors ¬∑ Built with ‚ù§Ô∏è and AI</div>
    </footer>
  </div><!-- /main-wrap -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
    window.addEventListener('load', () => {
      setTimeout(() => document.getElementById('loader').classList.add('hide'), 1800);
    });

    /* ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ */
    const cursor = document.getElementById('cursor');
    const ring   = document.getElementById('cursor-ring');
    let mx = 0, my = 0, rx = 0, ry = 0;
    document.addEventListener('mousemove', e => {
      mx = e.clientX; my = e.clientY;
      cursor.style.left = (mx - 6) + 'px';
      cursor.style.top  = (my - 6) + 'px';
    });
    (function animRing() {
      rx += (mx - rx) * .1; ry += (my - ry) * .1;
      ring.style.left = (rx - 19) + 'px';
      ring.style.top  = (ry - 19) + 'px';
      requestAnimationFrame(animRing);
    })();
    document.querySelectorAll('a, button, .type-card, .glass-card, .nav-link-item, .dropzone').forEach(el => {
      el.addEventListener('mouseenter', () => { cursor.style.transform = 'scale(2.4)'; ring.style.transform = 'scale(1.4)'; });
      el.addEventListener('mouseleave', () => { cursor.style.transform = 'scale(1)';   ring.style.transform = 'scale(1)'; });
    });

    /* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
    const canvas = document.getElementById('bg-canvas');
    const ctx    = canvas.getContext('2d');
    let W, H, dots = [];
    function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    for (let i = 0; i < 80; i++) dots.push({
      x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight,
      vx: (Math.random() - .5) * .18, vy: (Math.random() - .5) * .18,
      r: Math.random() * 1.3 + .3, a: Math.random() * .35 + .06
    });
    (function draw() {
      ctx.clearRect(0, 0, W, H);
      dots.forEach((d, i) => {
        dots.forEach((d2, j) => {
          if (j <= i) return;
          const dx = d.x - d2.x, dy = d.y - d2.y, dist = Math.hypot(dx, dy);
          if (dist < 115) { ctx.beginPath(); ctx.strokeStyle = `rgba(0,245,212,${.025*(1-dist/115)})`; ctx.lineWidth = .5; ctx.moveTo(d.x, d.y); ctx.lineTo(d2.x, d2.y); ctx.stroke(); }
        });
        d.x += d.vx; d.y += d.vy;
        if (d.x < 0 || d.x > W) d.vx *= -1;
        if (d.y < 0 || d.y > H) d.vy *= -1;
        ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(0,245,212,${d.a})`; ctx.fill();
      });
      requestAnimationFrame(draw);
    })();

    /* ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ */
    function tick() {
      const now = new Date();
      const el = document.getElementById('liveClock');
      if (el) el.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      const de = document.getElementById('heroDate');
      if (de) de.textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    }
    tick(); setInterval(tick, 1000);

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CORE UPLOAD LOGIC ‚Äî ALL FIXES APPLIED HERE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    let selectedType = '';
    const fileInput  = document.getElementById('fileInput');
    const dropzone   = document.getElementById('dropzone');

    /* ‚îÄ‚îÄ‚îÄ FIX: selectType sets hidden input value AND enables button check ‚îÄ‚îÄ‚îÄ */
    function selectType(type) {
      selectedType = type;
      document.getElementById('reportTypeInput').value = type;
      document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('card-' + type).classList.add('selected');
      document.getElementById('typeError').style.display = 'none';
      validateForm();
    }

    /* ‚îÄ‚îÄ‚îÄ FIX: validateForm correctly checks both conditions ‚îÄ‚îÄ‚îÄ */
    function validateForm() {
      const hasType = selectedType !== '';
      const hasFile = fileInput.files && fileInput.files.length > 0;
      document.getElementById('submitBtn').disabled = !(hasType && hasFile);
    }

    /* ‚îÄ‚îÄ‚îÄ File input change ‚îÄ‚îÄ‚îÄ */
    fileInput.addEventListener('change', function () {
      if (this.files.length > 0) handleFile(this.files[0]);
    });

    /* ‚îÄ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ */
    dropzone.addEventListener('dragover',  e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        /* ‚îÄ‚îÄ‚îÄ FIX: Use DataTransfer to properly assign dropped files ‚îÄ‚îÄ‚îÄ */
        try {
          const dt = new DataTransfer();
          dt.items.add(files[0]);
          fileInput.files = dt.files;
        } catch(err) { /* Safari fallback ‚Äî file stored in dragFile var */ }
        handleFile(files[0]);
      }
    });

    function handleFile(file) {
      if (!file.name.toLowerCase().endsWith('.csv')) {
        document.getElementById('fileError').style.display = 'block';
        document.getElementById('fileError').textContent = '‚ö† Only CSV files are accepted';
        return;
      }
      document.getElementById('fileError').style.display = 'none';
      document.getElementById('fileNameText').textContent = file.name;
      document.getElementById('fileSizeText').textContent = formatSize(file.size);
      document.getElementById('fileSelected').style.display = 'flex';
      dropzone.style.borderColor = 'var(--c-glow)';
      validateForm();
    }

    function removeFile() {
      fileInput.value = '';
      document.getElementById('fileSelected').style.display = 'none';
      dropzone.style.borderColor = '';
      validateForm();
    }

    /* ‚îÄ‚îÄ‚îÄ Progress stages ‚îÄ‚îÄ‚îÄ */
    const STAGES = [
      'Uploading file‚Ä¶',
      'Running ReportUnderstandingAgent‚Ä¶',
      'Running AnomalyDetectionAgent‚Ä¶',
      'Embedding with RAGEmbeddingAgent‚Ä¶',
      'Finalizing pipeline‚Ä¶',
      'Complete!'
    ];

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       FIX: handleUpload ‚Äî uses FormData correctly
       and redirects to /dashboard after success
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    async function handleUpload() {
      /* Double-check validation */
      if (!selectedType) {
        document.getElementById('typeError').style.display = 'block';
        return;
      }
      if (!fileInput.files || fileInput.files.length === 0) {
        document.getElementById('fileError').style.display = 'block';
        document.getElementById('fileError').textContent = '‚ö† Please select a CSV file';
        return;
      }

      /* Build FormData manually so hidden input value is always included */
      const formData = new FormData();
      formData.append('type', selectedType);          /* ‚îÄ‚îÄ‚îÄ FIX: explicit append ‚îÄ‚îÄ‚îÄ */
      formData.append('file', fileInput.files[0]);

      /* Show progress UI */
      document.getElementById('progressWrap').style.display = 'block';
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('successBanner').style.display = 'none';
      document.getElementById('anomalyWrap').style.display = 'none';
      document.getElementById('typeError').style.display = 'none';
      document.getElementById('fileError').style.display = 'none';

      let progress = 0, stage = 0;
      const dots = ['pd1','pd2','pd3','pd4','pd5','pd6'];

      const progressInterval = setInterval(() => {
        progress += Math.random() * 9;
        if (progress > 88) progress = 88;
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressPct').textContent = Math.round(progress) + '%';
        const ns = Math.floor((progress / 88) * (STAGES.length - 1));
        if (ns > stage) {
          stage = ns;
          document.getElementById('progressStage').textContent = STAGES[stage];
          for (let i = 0; i < stage; i++) document.getElementById(dots[i]).className = 'p-dot done';
          if (stage < dots.length) document.getElementById(dots[stage]).className = 'p-dot active';
        }
      }, 180);

      try {
        const res = await fetch('/upload', { method: 'POST', body: formData });
        clearInterval(progressInterval);

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'Upload failed. Please try again.' }));
          throw new Error(err.error || 'Upload failed');
        }

        const data = await res.json();

        /* Complete progress bar */
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressPct').textContent = '100%';
        document.getElementById('progressStage').textContent = STAGES[STAGES.length - 1];
        dots.forEach(id => document.getElementById(id).className = 'p-dot done');

        setTimeout(() => {
          document.getElementById('progressWrap').style.display = 'none';
          document.getElementById('successBanner').style.display = 'flex';

          const count = data.cached_count || 1;
          document.getElementById('successMsg').textContent =
            `Report #${count} stored ¬∑ Redirecting to dashboard‚Ä¶`;

          /* Show anomalies if any */
          if (data.anomalies && data.anomalies.length > 0) {
            const list = document.getElementById('anomalyList');
            list.innerHTML = '';
            data.anomalies.forEach(a => {
              const msg = a.message || a;
              const sev = (a.severity || 'medium').toLowerCase();
              const div = document.createElement('div');
              div.className = 'anomaly-item';
              div.innerHTML = `<span class="badge-sev badge-${sev}">${sev}</span><span>${msg}</span>`;
              list.appendChild(div);
            });
            document.getElementById('anomalyWrap').style.display = 'block';
          }

          addRecentUpload(fileInput.files[0].name, selectedType);

          /* ‚îÄ‚îÄ‚îÄ FIX: Redirect to /dashboard after success ‚îÄ‚îÄ‚îÄ */
          setTimeout(() => { window.location.href = '/dashboard'; }, 2000);

        }, 500);

      } catch (err) {
        clearInterval(progressInterval);
        document.getElementById('progressWrap').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
        validateForm();

        /* Show error as a styled banner instead of ugly alert */
        const banner = document.getElementById('successBanner');
        banner.style.display = 'flex';
        banner.style.borderLeftColor = 'var(--c-ruby)';
        banner.style.background = 'rgba(244,63,94,.06)';
        banner.style.borderColor = 'rgba(244,63,94,.2)';
        banner.querySelector('.success-ico').textContent = '‚ùå';
        banner.querySelector('.success-title').style.color = 'var(--c-ruby)';
        banner.querySelector('.success-title').textContent = 'Upload Failed';
        banner.querySelector('.success-msg').textContent = err.message;
      }
    }

    /* ‚îÄ‚îÄ Recent uploads ‚îÄ‚îÄ */
    const recentUploads = [];
    function addRecentUpload(name, type) {
      recentUploads.unshift({ name, type, time: new Date() });
      renderRecent();
    }
    function renderRecent() {
      if (!recentUploads.length) { document.getElementById('recentSection').style.display = 'none'; return; }
      document.getElementById('recentSection').style.display = 'block';
      const list = document.getElementById('recentList');
      list.innerHTML = '';
      recentUploads.slice(0, 5).forEach(u => {
        const div = document.createElement('div');
        div.className = 'recent-item';
        div.innerHTML = `
          <div class="recent-ico">${u.type === 'invoice' ? 'üßæ' : 'üí∏'}</div>
          <div style="flex:1;min-width:0;">
            <div class="recent-name">${u.name}</div>
            <div class="recent-time">${timeAgo(u.time)} ¬∑ ${u.type}</div>
          </div>
          <span class="done-badge">DONE</span>`;
        list.appendChild(div);
      });
    }
    function timeAgo(d) {
      const s = Math.floor((new Date() - d) / 1000);
      if (s < 60) return 'just now';
      if (s < 3600) return Math.floor(s/60) + 'm ago';
      return Math.floor(s/3600) + 'h ago';
    }

    function resetForm() {
      selectedType = '';
      fileInput.value = '';
      document.getElementById('reportTypeInput').value = '';
      document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('fileSelected').style.display = 'none';
      document.getElementById('progressWrap').style.display = 'none';
      document.getElementById('successBanner').style.display = 'none';
      document.getElementById('anomalyWrap').style.display = 'none';
      document.getElementById('progressFill').style.width = '0%';
      document.querySelectorAll('.p-dot').forEach(d => d.className = 'p-dot');
      document.getElementById('typeError').style.display = 'none';
      document.getElementById('fileError').style.display = 'none';
      dropzone.style.borderColor = '';

      /* Reset error banner styling */
      const banner = document.getElementById('successBanner');
      banner.style.cssText = '';
      banner.querySelector('.success-ico').textContent = '‚úÖ';
      banner.querySelector('.success-title').style.color = '';
      banner.querySelector('.success-title').textContent = 'Report processed successfully!';

      validateForm();
    }

    function formatSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024, s = ['B','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
    }
  </script>
</body>
</html>